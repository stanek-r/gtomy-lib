image: node:18.17-bullseye

stages:
  - checks
  - build
  - deploy
  - storybook

lint-check:
  stage: checks
  before_script:
    - npm i --silent
  script:
    - npm run lint:check
  only:
    - main
    - merge_requests

audit:
  stage: checks
  allow_failure: true
  script:
    - npm audit --audit-level=critical
  only:
    - main
    - merge_requests

build:
  stage: build
  artifacts:
    untracked: true
  before_script:
    - npm i --silent
  script:
    - npm run build
  only:
    - main
    - merge_requests

deploy-manual:
  stage: deploy
  dependencies:
    - build
  script:
    - echo "//registry.npmjs.org/:_authToken=${CI_NPM_TOKEN}" > .npmrc
    - npm publish
  only:
    - web

deploy-auto:
  stage: deploy
  dependencies:
    - build
  script:
    - echo "//registry.npmjs.org/:_authToken=${CI_NPM_TOKEN}" > .npmrc
    - npm publish
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /chore\(release\):/

pages-auto:
  stage: storybook
  allow_failure: true
  before_script:
    - npm i --silent
  script:
    - npm run build-storybook
  artifacts:
    paths:
      - public
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /chore\(release\):/

pages-manual:
  stage: storybook
  allow_failure: true
  before_script:
    - npm i --silent
  script:
    - npm run build-storybook
  artifacts:
    paths:
      - public
  only:
    - web

